var Y=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var O=(e,o,a)=>o in e?Y(e,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[o]=a,D=(e,o)=>{for(var a in o||(o={}))W.call(o,a)&&O(e,a,o[a]);if(E)for(var a of E(o))U.call(o,a)&&O(e,a,o[a]);return e},T=(e,o)=>Z(e,ee(o));var G=(e,o)=>{var a={};for(var n in e)W.call(e,n)&&o.indexOf(n)<0&&(a[n]=e[n]);if(e!=null&&E)for(var n of E(e))o.indexOf(n)<0&&U.call(e,n)&&(a[n]=e[n]);return a};import{r as m,ac as te,a as r,j as u,F as _}from"./index.js";import{L as oe}from"./Loader.js";import{u as re}from"./useFirstFetch.js";import{u as P}from"./useModal.js";import"./jwt-decode.esm.js";import{H as ae}from"./HeaderTitle.js";import"./BootstrapTooltip.js";import{N as ne}from"./NotFoundResults.js";import"./ContentProvider.js";import{M as H}from"./Modal2.js";import"./platform.js";import{g as q}from"./dateHelper.js";import{S as M}from"./Stack.js";import{T as h}from"./Typography.js";import{D as se}from"./Divider.js";import{C as ie}from"./CustomTable.js";import{f,n as ce}from"./string.helper.js";import le from"./CustomSpeedDial.js";import{c as de,i as me,r as ue}from"./jsx-runtime_commonjs-proxy.js";import{d as pe}from"./ScheduleSend.js";import{F as he}from"./FileSaver.min.js";import{E as fe}from"./exceljs.min.js";import{u as N}from"./useFetch.js";import{T as xe}from"./TextInput.js";import{c as ge,a as Ce,f as be,o as _e}from"./array.js";import{A as J}from"./Alert.js";import{F as ve}from"./FormControlLabel.js";import{C as Fe}from"./Checkbox.js";import{A as $e}from"./AlertTitle.js";import"./Grid.js";import"./extendSxProp.js";import"./useAsyncRetry.js";import"./tslib.js";import"./useHttpService.js";import"./constants.js";import"./Tooltip.js";import"./Portal.js";import"./useControlled.js";import"./useIsFocusVisible.js";import"./isHostComponent.js";import"./Grow.js";import"./Close2.js";import"./IconButton.js";import"./ButtonBase.js";import"./Error.js";import"./Backdrop.js";import"./Modal.js";import"./Paper.js";import"./Button.js";import"./index13.js";import"./Search.js";import"./Clear.js";import"./TextField.js";import"./react-is.production.min.js";import"./Menu.js";import"./List.js";import"./createSvgIcon.js";import"./GlobalStyles.js";import"./Box.js";import"./InputAdornment.js";import"./FormGroup.js";import"./SkipNextOutlined.js";import"./Pagination.js";import"./regex.js";import"./Assignment.js";import"./FabButtonAction.js";import"./AssignmentRounded.js";import"./upperFirst.js";import"./Close.js";const v=m.exports.createContext({}),ye=({children:e})=>{const{id:o}=te(),a=P(),n=P(),i=P(),[p,t]=m.exports.useState(),C=re({url:`/admin/formulario03/${o}`}),{value:s}=C,c=G(C,["value"]),[y,g]=m.exports.useState(),F=($,l)=>{var w;g((w=p==null?void 0:p.planillas.find(S=>S.id===$))==null?void 0:w.contratos[l]),a.setOpen()};return m.exports.useEffect(()=>{(()=>{s!=null&&s.data&&t(s.data)})()},[s]),r(v.Provider,{value:D({contrato:y,setContrato:g,handleSetContrato:F,modalEdit:a,modalProcesar:n,modalDownload:i,value:s,data:p,setData:t},c),children:e})},De=()=>{const{data:e}=m.exports.useContext(v);return u(M,{direction:"column",spacing:1,style:{padding:10,border:"1px solid black",borderRadius:"5px"},children:[u(M,{direction:{xs:"column",md:"row"},justifyContent:"space-between",spacing:1,children:[r(h,{variant:"h5",color:"green",fontWeight:"bold",textTransform:"uppercase",children:e==null?void 0:e.nom_cliente}),u(h,{variant:"h5",textTransform:"uppercase",children:[r("strong",{children:"Mes:"})," ",q(e.mes,"MMMM - yyyy")]})]}),r(se,{}),u(M,{direction:{xs:"column",md:"row"},spacing:1,children:[u(h,{children:[r("strong",{children:"RUC:"})," ",e==null?void 0:e.ruc]}),(e==null?void 0:e.dv)&&u(h,{children:[r("strong",{children:"DV:"})," ",e==null?void 0:e.dv]})]}),(e==null?void 0:e.telefono)||(e==null?void 0:e.celular)?u(h,{children:[r("strong",{children:"T\xE9lefono:"})," ",(e==null?void 0:e.telefono)||(e==null?void 0:e.celular)]}):r(_,{})]})},we=e=>{var p;const{handleSetContrato:o}=m.exports.useContext(v),a=m.exports.useMemo(()=>e.contratos.every(t=>Number(t.preaviso)>0),[e]),n=m.exports.useMemo(()=>e.contratos.every(t=>Number(t.indemnizacion)>0),[e]),i=m.exports.useMemo(()=>e.contratos.some(t=>t.dv&&t.dv!==""),[e]);return r(ie,{title:u(h,{variant:"h6",color:"red",fontWeight:"bold",textTransform:"uppercase",children:[e.tipo," ",e.nombre_negocio]}),size:"small",stickyHeader:!0,sx:{maxHeight:t=>`calc(100vh - ${t.spacing(15)})`},tableHeader:["#","Nombre","C\xE9dula",...i?["DV"]:[],"Salario","D\xE9cimo","Vacaciones","Imp. Renta","Horas Extras","Comisones",...a?["Preaviso"]:[],...n?["Indemnizaci\xF3n"]:[]],tableBody:e.contratos.map((t,s)=>[s+1,u(h,{textTransform:"uppercase",style:{cursor:"pointer"},onClick:()=>o(e.id,s),children:[t.nombre," ",t.apellido]},`${t.id_contrato}-nombre`),r(h,{textTransform:"uppercase",children:t.identificacion},`${t.id_contrato}-cedula`),...i?[r(h,{textTransform:"uppercase",children:t.dv},`${t.id_contrato}-dv`)]:[],r(h,{children:f(t.salario)},`${t.id_contrato}-salario`),r(h,{children:f(t.decimo)},`${t.id_contrato}-decimo`),r(h,{children:f(t.vacaciones)},`${t.id_contrato}-vacaciones`),r(h,{children:f(t.impuesto_renta)},`${t.id_contrato}-impuesto`),r(h,{children:f(t.horas_extras)},`${t.id_contrato}-extras`),r(h,{children:f(t.comisiones)},`${t.id_contrato}-comisiones`),...a?[r(h,{children:f(t.preaviso)},`${t.id_contrato}-preaviso`)]:[],...n?[r(h,{children:f(t.indemnizacion)},`${t.id_contrato}-idemnizacion`)]:[]]).concat([...((p=e.contratos)==null?void 0:p.length)>0?[["","Totales","",...i?[""]:[],f(e.contratos.map(t=>Number(t.salario||0)).reduce((t,s)=>t+s)),f(e.contratos.map(t=>Number(t.decimo||0)).reduce((t,s)=>t+s)),f(e.contratos.map(t=>Number(t.vacaciones||0)).reduce((t,s)=>t+s)),f(e.contratos.map(t=>Number(t.impuesto_renta||0)).reduce((t,s)=>t+s)),f(e.contratos.map(t=>Number(t.horas_extras||0)).reduce((t,s)=>t+s)),f(e.contratos.map(t=>Number(t.comisiones||0)).reduce((t,s)=>t+s)),...a?[f(e.contratos.map(t=>Number(t.preaviso||0)).reduce((t,s)=>t+s))]:[],...n?[f(e.contratos.map(t=>Number(t.indemnizacion||0)).reduce((t,s)=>t+s))]:[]]]:[]])})};var R={},Se=me.exports;Object.defineProperty(R,"__esModule",{value:!0});var K=R.default=void 0,Me=Se(de),Ee=ue,Te=(0,Me.default)((0,Ee.jsx)("path",{d:"M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"}),"Download");K=R.default=Te;const k=m.exports.createContext({}),Ne=({children:e})=>{const[o,a]=m.exports.useState(!1),[n,i]=m.exports.useState(null);return r(k.Provider,{value:{loading:o,setLoading:a,response:n,setResponse:i},children:e})},Q=()=>{const{data:e,setData:o}=m.exports.useContext(v),{setLoading:a,setResponse:n}=m.exports.useContext(k),i=N(),p=N(),t=()=>{i.reset(),p.reset(),n(null),a(!1)},s=".xlsx";return{handleDownload:async()=>{try{a(!0);const y=`F03-${q(e.mes,"MMMM-yyyy")}-${e.nom_cliente}-${e.ruc}`.replaceAll(" ","-").toUpperCase(),g=await i.send({url:"/file/DemoInf_F03v4.xlsx",isBlob:!0});if(g&&g.status===201&&g.data){const F=g.data,C=await F.arrayBuffer(),$=new fe.Workbook;await $.xlsx.load(C);const l=$.getWorksheet(1);e.planillas.flatMap(x=>x.contratos).forEach((x,d)=>{l.getCell(`A${d+5}`).value=1,l.getCell(`B${d+5}`).value=ce(x.tipo_identificacion).includes("Cedula")?1:2,l.getCell(`C${d+5}`).value=x.identificacion,l.getCell(`D${d+5}`).value=x.dv,l.getCell(`E${d+5}`).value=`${x.nombre} ${x.apellido}`,l.getCell(`F${d+5}`).value=x.conyuge_no_trabaja||1,l.getCell(`G${d+5}`).value=Number(x.meses_trabajados),l.getCell(`H${d+5}`).value=Number(x.decimo)+Number(x.vacaciones)+Number(x.salario),l.getCell(`I${d+5}`).value=0,l.getCell(`J${d+5}`).value=0,l.getCell(`K${d+5}`).value=0,l.getCell(`L${d+5}`).value=0,l.getCell(`M${d+5}`).value=0,l.getCell(`N${d+5}`).value=0,l.getCell(`O${d+5}`).value=0,l.getCell(`P${d+5}`).value=0,l.getCell(`S${d+5}`).value=0,l.getCell(`T${d+5}`).value=0,l.getCell(`U${d+5}`).value=0,l.getCell(`V${d+5}`).value=0});const w=await $.xlsx.writeBuffer(),S=new Blob([w],{type:F.type});await p.send({url:`/admin/formulario03/${e.id}/down`,method:"POST"}),o(T(D({},e),{fecha_download:new Date(Date.now()).toString()})),he.exports.saveAs(S,`${y}${s}`),n({status:201,data:{message:"\xA1Archivo generado correctamente!"}})}else n({status:500,error:{message:"\xA1Error al generar el archivo!"}})}catch{n({status:500,error:{message:"\xA1Error al generar el archivo!"}})}finally{a(!1)}},handleReset:t}},Ae=()=>{const e=m.exports.useContext(v),{data:o,modalProcesar:a,modalDownload:n}=e,{handleDownload:i}=Q(),{setOpen:p}=a,t=()=>{o&&o.fecha_download?n.setOpen():i()};return r(_,{children:r(le,{titles:["Generar formato",...o!=null&&o.fecha_send?[]:["Marcar como procesada"]],icons:[K,...o!=null&&o.fecha_send?[]:[pe]],onPresses:[()=>t(),...o!=null&&o.fecha_send?[]:[()=>p()]]})})},Pe=ge().shape({dv:Ce().typeError("Favor ingresar el d\xEDgito verificador").trim().min(2,"Favor ingresar dos d\xEDgitos").max(2,"Favor ingresar dos d\xEDgitos").matches(/\d+/g,"Favor ingresar solo n\xFAmeros").required("Favor ingresar el d\xEDgito verificador")}),He=()=>{var B,j,I,z;const{modalEdit:e,contrato:o,setData:a,data:n}=m.exports.useContext(v),{modalState:i,setHide:p}=e,{response:t,reset:s,isLoading:c,send:y}=N(),g=()=>{p(),C.reset(),s()},F=async b=>{if((await y({url:`/admin/contratos/${o==null?void 0:o.id_contrato}/edit-planilla`,method:"POST",data:{nombre:b.nombre,apellido:b.apellido,identificacion:b.identificacion,tipoIdentificacion:b.tipo_identificacion,seguro:b.seguro,dv:b.dv,fecha_ini:b.fecha_ini,conyuge_no_trabaja:b.conyuge_no_trabaja}})).status===201&&o&&n){const V=n.planillas.findIndex(A=>A.contratos.includes(o)),X=n.planillas[V].contratos.findIndex(A=>A.id_contrato===(o==null?void 0:o.id_contrato)),L=n;L.planillas[V].contratos[X]=b,a(D({},L))}},C=be({mode:"all",resolver:_e(Pe)}),{register:$,formState:l}=C,{setValue:w,watch:S}=C,{errors:x}=l,d=S("conyuge_no_trabaja");return m.exports.useEffect(()=>{(()=>{o&&C.reset(D({},o))})()},[o]),r(_,{children:r(H,{state:i,title:"Formulario de edici\xF3n",setHide:g,cancelBotton:{text:"Cerrar",actionFunction:g},actionButton:{text:"Guardar",actionFunction:C.handleSubmit(F),isLoading:c},children:u(M,{direction:"column",spacing:1,children:[t&&!c&&r(J,{variant:"outlined",severity:(t==null?void 0:t.status)===201?"success":"error",children:t.status===201?(B=t.data)==null?void 0:B.message:(j=t.error)==null?void 0:j.message}),u(h,{variant:"h6",textTransform:"uppercase",children:[o==null?void 0:o.nombre," ",o==null?void 0:o.apellido]}),r(xe,T(D({label:"DV"},$("dv")),{error:!!((I=x.dv)!=null&&I.message),helperText:(z=x.dv)==null?void 0:z.message,fullWidth:!0,autoFocus:!0,focused:!0})),r(ve,{control:r(Fe,{checked:d===4,defaultChecked:d===4,onChange:b=>{w("conyuge_no_trabaja",b.target.checked?4:1)}}),label:"Casado(a) y c\xF3nyuge no trabaja"})]})})})},Re=()=>{var F,C;const{modalProcesar:e,data:o,setData:a}=m.exports.useContext(v),{modalState:n,setHide:i}=e,{isLoading:p,send:t,reset:s,response:c}=N(),y=async()=>{(await t({url:`/admin/formulario03/${o==null?void 0:o.id}/procesar`,method:"POST"})).status===201&&a(T(D({},o),{fecha_send:new Date(Date.now()).toString()}))},g=()=>{i(),s()};return r(_,{children:u(H,{title:"\xA1Atenci\xF3n!",type:(c==null?void 0:c.status)===201?"SUCCESS":"ERROR",state:n,setHide:g,cancelBotton:{text:"Cancelar",actionFunction:g},actionButton:(c==null?void 0:c.status)!==201?{text:"Procesar",actionFunction:y,isLoading:p}:void 0,children:[!c&&u("span",{children:["\xBFRealmente desea marcar como procesado el"," ",r("strong",{children:"Formulario 03"}),"?"]}),c&&c.status===201?(F=c==null?void 0:c.data)==null?void 0:F.message:(C=c==null?void 0:c.error)==null?void 0:C.message]})})},ke=()=>{var c;const{modalDownload:e}=m.exports.useContext(v),{modalState:o,setHide:a}=e,{loading:n,response:i}=m.exports.useContext(k),{handleDownload:p,handleReset:t}=Q(),s=()=>{a(),t()};return r(_,{children:r(H,{title:"\xA1Atenci\xF3n!",type:(i==null?void 0:i.status)===201?"SUCCESS":"WARNING",state:o,setHide:s,cancelBotton:{text:"Cerrar",actionFunction:s},actionButton:(i==null?void 0:i.status)!==201?{text:"Generar",actionFunction:p,isLoading:n}:void 0,children:i?r(_,{children:i.status===201?r(_,{children:i.data.message}):r(_,{children:(c=i.error)==null?void 0:c.message})}):u(_,{children:["El ",r("strong",{children:"formulario 03"})," ya ha sido generado, \xBFdesea volver a generarlo?"]})})})},Be=()=>{const{data:e}=m.exports.useContext(v);return u(Ne,{children:[u(M,{direction:"column",spacing:1,style:{marginTop:10},children:[e.planillas.flatMap(o=>o.contratos).some(o=>!o.dv||o.dv&&o.dv==="")&&u(J,{variant:"outlined",severity:"error",children:[r($e,{style:{fontWeight:"bold"},children:"\xA1Atenci\xF3n!"}),"Algunos de los empleados no cuentan con ",r("strong",{children:"DV"}),". Favor actualizarlos haciendo click en el nombre correspondiente."]}),e.planillas.map(o=>r(we,D({},o),o.id_planilla))]}),r(Ae,{}),r(He,{}),r(Re,{}),r(ke,{})]})},je=()=>{var n;const{loading:e,value:o,data:a}=m.exports.useContext(v);return u(_,{children:[r(ae,{message:"Formulario 03"}),u("div",{style:{display:"flex",flexDirection:"column",marginTop:10},children:[e&&r(oe,{}),!e&&o&&(o==null?void 0:o.status)!==201&&r(ne,{text:(n=o==null?void 0:o.error)==null?void 0:n.message}),!e&&o&&(o==null?void 0:o.status)===201&&o.data&&a&&u(_,{children:[r(De,{}),r(Be,{})]})]})]})},oo=()=>r(ye,{children:r(je,{})});export{oo as default};
