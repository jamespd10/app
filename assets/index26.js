var ee=Object.defineProperty,oe=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var W=(o,e,a)=>e in o?ee(o,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[e]=a,D=(o,e)=>{for(var a in e||(e={}))G.call(e,a)&&W(o,a,e[a]);if(M)for(var a of M(e))q.call(e,a)&&W(o,a,e[a]);return o},P=(o,e)=>oe(o,te(e));var J=(o,e)=>{var a={};for(var r in o)G.call(o,r)&&e.indexOf(r)<0&&(a[r]=o[r]);if(o!=null&&M)for(var r of M(o))e.indexOf(r)<0&&q.call(o,r)&&(a[r]=o[r]);return a};import{r as m,ac as ae,a as t,j as i,F as _}from"./index.js";import{L as re}from"./Loader.js";import{u as ne}from"./useFirstFetch.js";import{u as R}from"./useModal.js";import"./jwt-decode.esm.js";import{H as se}from"./HeaderTitle.js";import"./BootstrapTooltip.js";import{N as le}from"./NotFoundResults.js";import"./ContentProvider.js";import{M as A}from"./Modal2.js";import"./platform.js";import{g as K}from"./dateHelper.js";import{S as $}from"./Stack.js";import{T as w}from"./Typography.js";import{D as ie}from"./Divider.js";import{f,n as ce}from"./string.helper.js";import{P as de}from"./Paper.js";import me from"./CustomSpeedDial.js";import{c as ue,i as he,r as pe}from"./jsx-runtime_commonjs-proxy.js";import{d as fe}from"./ScheduleSend.js";import{F as xe}from"./FileSaver.min.js";import{E as ge}from"./exceljs.min.js";import{u as T}from"./useFetch.js";import{T as Ce}from"./TextInput.js";import{c as ve,a as _e,f as Ne,o as be}from"./array.js";import{A as Q}from"./Alert.js";import{F as Fe}from"./FormControlLabel.js";import{C as ye}from"./Checkbox.js";import{A as De}from"./AlertTitle.js";import"./Grid.js";import"./extendSxProp.js";import"./useAsyncRetry.js";import"./tslib.js";import"./useHttpService.js";import"./constants.js";import"./Tooltip.js";import"./Portal.js";import"./useControlled.js";import"./useIsFocusVisible.js";import"./isHostComponent.js";import"./Grow.js";import"./Close2.js";import"./IconButton.js";import"./ButtonBase.js";import"./Error.js";import"./Backdrop.js";import"./Modal.js";import"./Button.js";import"./index13.js";import"./regex.js";import"./Assignment.js";import"./FabButtonAction.js";import"./react-is.production.min.js";import"./AssignmentRounded.js";import"./createSvgIcon.js";import"./TextField.js";import"./Menu.js";import"./List.js";import"./GlobalStyles.js";import"./upperFirst.js";import"./Close.js";const N=m.exports.createContext({}),we=({children:o})=>{const{id:e}=ae(),a=R(),r=R(),s=R(),[h,l]=m.exports.useState(),C=ne({url:`/admin/formulario03/${e}`}),{value:p}=C,c=J(C,["value"]),[y,g]=m.exports.useState(),b=(F,d)=>{var S;g((S=h==null?void 0:h.planillas.find(E=>E.id===F))==null?void 0:S.contratos[d]),a.setOpen()};return m.exports.useEffect(()=>{(()=>{p!=null&&p.data&&l(p.data)})()},[p]),t(N.Provider,{value:D({contrato:y,setContrato:g,handleSetContrato:b,modalEdit:a,modalProcesar:r,modalDownload:s,value:p,data:h,setData:l},c),children:o})},Se=()=>{const{data:o}=m.exports.useContext(N);return i($,{direction:"column",spacing:1,style:{padding:10,border:"1px solid black",borderRadius:"5px"},children:[i($,{direction:{xs:"column",md:"row"},justifyContent:"space-between",spacing:1,children:[t(w,{variant:"h5",color:"green",fontWeight:"bold",textTransform:"uppercase",children:o==null?void 0:o.nom_cliente}),i(w,{variant:"h5",textTransform:"uppercase",children:[t("strong",{children:"Mes:"})," ",K(o.mes,"MMMM - yyyy")]})]}),t(ie,{}),i($,{direction:{xs:"column",md:"row"},spacing:1,children:[i(w,{children:[t("strong",{children:"RUC:"})," ",o==null?void 0:o.ruc]}),(o==null?void 0:o.dv)&&i(w,{children:[t("strong",{children:"DV:"})," ",o==null?void 0:o.dv]})]}),(o==null?void 0:o.telefono)||(o==null?void 0:o.celular)?i(w,{children:[t("strong",{children:"T\xE9lefono:"})," ",(o==null?void 0:o.telefono)||(o==null?void 0:o.celular)]}):t(_,{})]})},$e="_tableResponse_553e5_1",Ee="_table_553e5_1",Me="_header_553e5_21",Pe="_column_553e5_61",Te="_row_553e5_75",ke="_columnClick_553e5_103",Re="_columnClickEdit_553e5_113";var n={tableResponse:$e,table:Ee,header:Me,column:Pe,row:Te,columnClick:ke,columnClickEdit:Re};const H=o=>{const e=m.exports.useMemo(()=>o.every(s=>Number(s.preaviso)>0),[o]),a=m.exports.useMemo(()=>o.every(s=>Number(s.indemnizacion)>0),[o]),r=m.exports.useMemo(()=>o.some(s=>s.dv&&s.dv!==""),[o]);return{isPreaviso:e,isIndemnizacion:a,isDv:r}},Ae=({planilla:o})=>{const{handleSetContrato:e}=m.exports.useContext(N),{contratos:a}=o,{isDv:r,isIndemnizacion:s,isPreaviso:h}=H(a);return t(_,{children:a.map((l,p)=>i("tr",{className:n.row,children:[i("td",{className:`${n.column} ${n.columnClick}`,onClick:()=>e(o.id,p),children:[t("div",{className:n.columnClickEdit,children:t("span",{})}),i("span",{children:[l.nombre," ",l.apellido]})]}),t("td",{className:n.column,children:l.identificacion}),r&&t("td",{className:n.column,children:l.dv}),t("td",{className:n.column,children:f(l.salario)}),t("td",{className:n.column,children:f(l.decimo)}),t("td",{className:n.column,children:f(l.vacaciones)}),t("td",{className:n.column,children:f(l.impuesto_renta)}),t("td",{className:n.column,children:f(l.horas_extras)}),t("td",{className:n.column,children:f(l.comisiones)}),s&&t("td",{className:n.column,children:f(l.comisiones)}),h&&t("td",{className:n.column,children:f(l.comisiones)})]},`${l.id_contrato}`))})},He=({contratos:o})=>{const{isDv:e,isIndemnizacion:a,isPreaviso:r}=H(o);return t("thead",{children:i("tr",{children:[t("td",{className:n.header,children:"Nombre"}),t("td",{className:n.header,children:"C\xE9dula"}),e&&t("td",{className:n.header,children:"Dv"}),t("td",{className:n.header,children:"Salario"}),t("td",{className:n.header,children:"D\xE9cimo"}),t("td",{className:n.header,children:"Vacaciones"}),t("td",{className:n.header,children:"Imp. Renta"}),t("td",{className:n.header,children:"Horas extras"}),t("td",{className:n.header,children:"Comisiones"}),a&&t("td",{className:n.header,children:"Comisiones"}),r&&t("td",{className:n.header,children:"Comisiones"})]})})},Be=()=>m.exports.useCallback((e,a)=>a.map(r=>Number(r[e])).reduce((r,s)=>r+s),[]),Ie=({contratos:o})=>{const e=Be(),{isDv:a,isIndemnizacion:r,isPreaviso:s}=H(o);return i("tr",{className:n.row,children:[t("td",{className:n.column,children:"Totales"}),t("td",{className:n.column}),a&&t("td",{className:n.column}),t("td",{className:n.column,children:f(e("salario",o))}),t("td",{className:n.column,children:f(e("decimo",o))}),t("td",{className:n.column,children:f(e("vacaciones",o))}),t("td",{className:n.column,children:f(e("impuesto_renta",o))}),t("td",{className:n.column,children:f(e("horas_extras",o))}),t("td",{className:n.column,children:f(e("comisiones",o))}),r&&t("td",{className:n.column,children:f(e("indemnizacion",o))}),s&&t("td",{className:n.column,children:f(e("preaviso",o))})]})},je=o=>{const{contratos:e,nombre_negocio:a,tipo:r}=o;return i($,{component:de,direction:"column",variant:"outlined",children:[i(w,{variant:"h5",color:"red",padding:1,children:[r," ",a]}),t("div",{className:n.tableResponse,children:i("table",{className:n.table,children:[t(He,{contratos:e}),i("tbody",{children:[t(Ae,{planilla:o}),t(Ie,{contratos:e})]})]})})]})};var B={},ze=he.exports;Object.defineProperty(B,"__esModule",{value:!0});var X=B.default=void 0,Ve=ze(ue),Le=pe,Oe=(0,Ve.default)((0,Le.jsx)("path",{d:"M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"}),"Download");X=B.default=Oe;const I=m.exports.createContext({}),Ue=({children:o})=>{const[e,a]=m.exports.useState(!1),[r,s]=m.exports.useState(null);return t(I.Provider,{value:{loading:e,setLoading:a,response:r,setResponse:s},children:o})},Y=()=>{const{data:o,setData:e}=m.exports.useContext(N),{setLoading:a,setResponse:r}=m.exports.useContext(I),s=T(),h=T(),l=()=>{s.reset(),h.reset(),r(null),a(!1)},p=".xlsx";return{handleDownload:async()=>{try{a(!0);const y=`F03-${K(o.mes,"MMMM-yyyy")}-${o.nom_cliente}-${o.ruc}`.replaceAll(" ","-").toUpperCase(),g=await s.send({url:"/file/DemoInf_F03v4.xlsx",isBlob:!0});if(g&&g.status===201&&g.data){const b=g.data,C=await b.arrayBuffer(),F=new ge.Workbook;await F.xlsx.load(C);const d=F.getWorksheet(1);o.planillas.flatMap(x=>x.contratos).forEach((x,u)=>{d.getCell(`A${u+5}`).value=1,d.getCell(`B${u+5}`).value=ce(x.tipo_identificacion).includes("Cedula")?1:2,d.getCell(`C${u+5}`).value=x.identificacion,d.getCell(`D${u+5}`).value=x.dv,d.getCell(`E${u+5}`).value=`${x.nombre} ${x.apellido}`,d.getCell(`F${u+5}`).value=x.conyuge_no_trabaja||1,d.getCell(`G${u+5}`).value=Number(x.meses_trabajados),d.getCell(`H${u+5}`).value=Number(x.decimo)+Number(x.vacaciones)+Number(x.salario),d.getCell(`I${u+5}`).value=0,d.getCell(`J${u+5}`).value=0,d.getCell(`K${u+5}`).value=0,d.getCell(`L${u+5}`).value=0,d.getCell(`M${u+5}`).value=0,d.getCell(`N${u+5}`).value=0,d.getCell(`O${u+5}`).value=0,d.getCell(`P${u+5}`).value=0,d.getCell(`S${u+5}`).value=0,d.getCell(`T${u+5}`).value=0,d.getCell(`U${u+5}`).value=0,d.getCell(`V${u+5}`).value=0});const S=await F.xlsx.writeBuffer(),E=new Blob([S],{type:b.type});await h.send({url:`/admin/formulario03/${o.id}/down`,method:"POST"}),e(P(D({},o),{fecha_download:new Date(Date.now()).toString()})),xe.exports.saveAs(E,`${y}${p}`),r({status:201,data:{message:"\xA1Archivo generado correctamente!"}})}else r({status:500,error:{message:"\xA1Error al generar el archivo!"}})}catch{r({status:500,error:{message:"\xA1Error al generar el archivo!"}})}finally{a(!1)}},handleReset:l}},We=()=>{const o=m.exports.useContext(N),{data:e,modalProcesar:a,modalDownload:r}=o,{handleDownload:s}=Y(),{setOpen:h}=a,l=()=>{e&&e.fecha_download?r.setOpen():s()};return t(_,{children:t(me,{titles:["Generar formato",...e!=null&&e.fecha_send?[]:["Marcar como procesada"]],icons:[X,...e!=null&&e.fecha_send?[]:[fe]],onPresses:[()=>l(),...e!=null&&e.fecha_send?[]:[()=>h()]]})})},Ge=ve().shape({dv:_e().typeError("Favor ingresar el d\xEDgito verificador").trim().min(2,"Favor ingresar dos d\xEDgitos").max(2,"Favor ingresar dos d\xEDgitos").matches(/\d+/g,"Favor ingresar solo n\xFAmeros").required("Favor ingresar el d\xEDgito verificador")}),qe=()=>{var j,z,V,L;const{modalEdit:o,contrato:e,setData:a,data:r}=m.exports.useContext(N),{modalState:s,setHide:h}=o,{response:l,reset:p,isLoading:c,send:y}=T(),g=()=>{h(),C.reset(),p()},b=async v=>{if((await y({url:`/admin/contratos/${e==null?void 0:e.id_contrato}/edit-planilla`,method:"POST",data:{nombre:v.nombre,apellido:v.apellido,identificacion:v.identificacion,tipoIdentificacion:v.tipo_identificacion,seguro:v.seguro,dv:v.dv,fecha_ini:v.fecha_ini,conyuge_no_trabaja:v.conyuge_no_trabaja}})).status===201&&e&&r){const O=r.planillas.findIndex(k=>k.contratos.includes(e)),Z=r.planillas[O].contratos.findIndex(k=>k.id_contrato===(e==null?void 0:e.id_contrato)),U=r;U.planillas[O].contratos[Z]=v,a(D({},U))}},C=Ne({mode:"all",resolver:be(Ge)}),{register:F,formState:d}=C,{setValue:S,watch:E}=C,{errors:x}=d,u=E("conyuge_no_trabaja");return m.exports.useEffect(()=>{(()=>{e&&C.reset(D({},e))})()},[e]),t(_,{children:t(A,{state:s,title:"Formulario de edici\xF3n",setHide:g,cancelBotton:{text:"Cerrar",actionFunction:g},actionButton:{text:"Guardar",actionFunction:C.handleSubmit(b),isLoading:c},children:i($,{direction:"column",spacing:1,children:[l&&!c&&t(Q,{variant:"outlined",severity:(l==null?void 0:l.status)===201?"success":"error",children:l.status===201?(j=l.data)==null?void 0:j.message:(z=l.error)==null?void 0:z.message}),i(w,{variant:"h6",textTransform:"uppercase",children:[e==null?void 0:e.nombre," ",e==null?void 0:e.apellido]}),t(Ce,P(D({label:"DV"},F("dv")),{error:!!((V=x.dv)!=null&&V.message),helperText:(L=x.dv)==null?void 0:L.message,fullWidth:!0,autoFocus:!0,focused:!0})),t(Fe,{control:t(ye,{checked:u===4,onChange:v=>{S("conyuge_no_trabaja",v.target.checked?4:1)}}),label:"Casado(a) y c\xF3nyuge no trabaja"})]})})})},Je=()=>{var b,C;const{modalProcesar:o,data:e,setData:a}=m.exports.useContext(N),{modalState:r,setHide:s}=o,{isLoading:h,send:l,reset:p,response:c}=T(),y=async()=>{(await l({url:`/admin/formulario03/${e==null?void 0:e.id}/procesar`,method:"POST"})).status===201&&a(P(D({},e),{fecha_send:new Date(Date.now()).toString()}))},g=()=>{s(),p()};return t(_,{children:i(A,{title:"\xA1Atenci\xF3n!",type:(c==null?void 0:c.status)===201?"SUCCESS":"ERROR",state:r,setHide:g,cancelBotton:{text:"Cancelar",actionFunction:g},actionButton:(c==null?void 0:c.status)!==201?{text:"Procesar",actionFunction:y,isLoading:h}:void 0,children:[!c&&i("span",{children:["\xBFRealmente desea marcar como procesado el"," ",t("strong",{children:"Formulario 03"}),"?"]}),c&&c.status===201?(b=c==null?void 0:c.data)==null?void 0:b.message:(C=c==null?void 0:c.error)==null?void 0:C.message]})})},Ke=()=>{var c;const{modalDownload:o}=m.exports.useContext(N),{modalState:e,setHide:a}=o,{loading:r,response:s}=m.exports.useContext(I),{handleDownload:h,handleReset:l}=Y(),p=()=>{a(),l()};return t(_,{children:t(A,{title:"\xA1Atenci\xF3n!",type:(s==null?void 0:s.status)===201?"SUCCESS":"WARNING",state:e,setHide:p,cancelBotton:{text:"Cerrar",actionFunction:p},actionButton:(s==null?void 0:s.status)!==201?{text:"Generar",actionFunction:h,isLoading:r}:void 0,children:s?t(_,{children:s.status===201?t(_,{children:s.data.message}):t(_,{children:(c=s.error)==null?void 0:c.message})}):i(_,{children:["El ",t("strong",{children:"formulario 03"})," ya ha sido generado, \xBFdesea volver a generarlo?"]})})})},Qe=()=>{const{data:o}=m.exports.useContext(N);return i(Ue,{children:[i($,{direction:"column",spacing:1,style:{marginTop:10},children:[o.planillas.flatMap(e=>e.contratos).some(e=>!e.dv||e.dv&&e.dv==="")&&i(Q,{variant:"outlined",severity:"error",children:[t(De,{style:{fontWeight:"bold"},children:"\xA1Atenci\xF3n!"}),"Algunos de los empleados no cuentan con ",t("strong",{children:"DV"}),". Favor actualizarlos haciendo click en el nombre correspondiente."]}),o.planillas.map(e=>t(je,D({},e),e.id_planilla))]}),t(We,{}),t(qe,{}),t(Je,{}),t(Ke,{})]})},Xe=()=>{var r;const{loading:o,value:e,data:a}=m.exports.useContext(N);return i(_,{children:[t(se,{message:"Formulario 03"}),i("div",{style:{display:"flex",flexDirection:"column",marginTop:10},children:[o&&t(re,{}),!o&&e&&(e==null?void 0:e.status)!==201&&t(le,{text:(r=e==null?void 0:e.error)==null?void 0:r.message}),!o&&e&&(e==null?void 0:e.status)===201&&e.data&&a&&i(_,{children:[t(Se,{}),t(Qe,{})]})]})]})},it=()=>t(we,{children:t(Xe,{})});export{it as default};
